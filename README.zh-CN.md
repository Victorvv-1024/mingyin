# 销售预测管道 - 完整指南

[English](README.md) | **中文简体**

本仓库包含一个**生产就绪的模块化销售预测管道**，具有先进的深度学习模型，用于准确的销售预测。系统支持基线模型和增强模型，具有全面的评估功能。

## 🏗️ 架构概览

### **三阶段管道**

```
📊 阶段1：特征工程
├── 原始数据处理（Excel文件）
├── 316个工程化特征
├── 中国市场特定特征
├── 滚动时间分割准备
└── 工程化数据集输出

🤖 阶段2：模型训练  
├── 原版模型（基线）
├── 增强模型（高级）
├── 滚动分割验证
├── 模型比较
└── 最佳模型保存

🎯 阶段3：模型评估
├── 2023年数据测试
├── 性能分析
├── 可视化生成
└── 业务建议
```

### **模型架构**

我们提供**两个互补的模型**：

| 模型 | 描述 | 用途 |
|-------|-------------|----------|
| **原版嵌入模型** | 原始基线实现 | 比较基准，稳定基线 |
| **增强嵌入模型** | 具有改进的高级架构 | 生产部署，最佳性能 |

## 🚀 快速开始

### **选项1：完整管道（推荐）**

运行增强模型的所有三个阶段：

```bash
python src/scripts/run_complete_pipeline.py \
    --data-dir data/raw \
    --output-dir outputs \
    --years 2021 2022 \
    --epochs 100 \
    --model-type enhanced \
    --run-phase3
```

### **选项2：模型比较**

训练两个模型并比较性能：

```bash
python src/scripts/run_complete_pipeline.py \
    --data-dir data/raw \
    --output-dir outputs \
    --years 2021 2022 \
    --epochs 100 \
    --model-type both \
    --run-phase3
```

### **选项3：单独阶段**

```bash
# 阶段1：特征工程
python src/scripts/phase1_feature_engineering.py --data-dir data/raw --output-dir outputs/engineered

# 阶段2：模型训练  
python src/scripts/phase2_model_training.py --engineered-dataset outputs/engineered/dataset.pkl --output-dir outputs/models

# 阶段3：模型评估
python src/scripts/phase3_test_model.py --models-dir outputs/models --engineered-dataset outputs/engineered/dataset.pkl
```

## 📁 项目结构

```
📁 src/
├── 📁 data/                          # 数据处理管道
│   ├── 📄 feature_pipeline.py        # 主特征协调
│   ├── 📄 preprocessing.py           # 数据清理和准备
│   ├── 📄 utils.py                   # 数据实用函数
│   └── 📁 features/                  # 专业化特征工程
│       ├── 📄 temporal.py            # 基于时间 + 中国日历
│       ├── 📄 customer_behavior.py   # 店铺分析
│       ├── 📄 store_categorization.py # 中国店铺分类
│       ├── 📄 platform_dynamics.py   # 跨平台竞争
│       └── 📄 promotional_calendar.py # 电商活动
├── 📁 models/                        # 深度学习模型
│   ├── 📄 vanilla_embedding_model.py # 基线模型
│   ├── 📄 enhanced_embedding_model.py # 高级模型
│   ├── 📄 feature_processor.py       # 多输入数据准备
│   ├── 📄 trainer.py                 # 训练协调
│   └── 📄 custom_objects.py          # 共享TensorFlow组件
├── 📁 scripts/                       # 执行脚本
│   ├── 📄 run_complete_pipeline.py   # 主管道（所有阶段）
│   ├── 📄 phase1_feature_engineering.py # 仅特征工程
│   ├── 📄 phase2_model_training.py   # 仅模型训练
│   └── 📄 phase3_test_model.py       # 仅模型评估
├── 📁 utils/                         # 实用工具
│   ├── 📄 logging_utils.py           # 标准化日志
│   ├── 📄 args_utils.py              # 参数解析实用程序
│   └── 📄 helpers.py                 # 通用实用程序
└── 📁 config/                        # 配置
    └── 📄 feature_config.yaml        # 特征工程设置

📁 docs/                              # 文档
└── 📄 USAGE_GUIDE.zh-CN.md           # 详细使用指南（中文）

📁 outputs/                           # 生成的输出
├── 📁 engineered/                    # 阶段1输出
├── 📁 {实验名称}/                     # 阶段2和3输出
│   ├── 📁 vanilla_models/            # 原版模型文件
│   ├── 📁 enhanced_models/           # 增强模型文件
│   ├── 📁 predictions/               # 模型预测
│   ├── 📁 reports/                   # 性能报告
│   │   ├── 📄 training_summary.txt     # 训练结果
│   │   ├── 📄 model_comparison.json    # 模型比较指标
│   │   └── 📄 experiment_metadata.json # 实验配置
│   └── 📁 2023_evaluation/           # 阶段3评估结果
```

## 🎯 特征工程

我们的管道在9个主要类别中创建**316个复杂特征**，专门为中国电商销售预测设计：

### **🕒 时间特征（24个特征）**

**基本时间（19个特征）：**
- **日历特征**：月、季度、年、年中第几天进度
- **循环编码**：月、季度、年中第几天的正弦/余弦变换
- **中国市场事件**：春节、年中购物节、双十一
- **平台交互**：特定月份的平台表现（抖音、京东、天猫）
- **关系指标**：平台使用时长、关系持续时间跟踪

**循环模式（5个特征）：**
- **时间进度**：自纪元天数、周正弦/余弦编码
- **市场事件**：双十一检测、促销期间
- **品牌专业化**：单品牌专家指标

### **🎯 促销和季节特征（12个特征）**
- **事件检测**：假期季节、促销期间识别
- **时间接近度**：到下次促销活动的天数/距上次促销活动的天数
- **促销强度**：全市场促销活动强度测量
- **平台特定促销**：平台×促销交互效应
- **响应度细分**：高/中/低促销响应类别

### **📊 滞后和历史特征（15个特征）**
- **多周期滞后**：1、2、3、6、12个月历史值
- **多指标覆盖**：销售、金额、价格滞后特征
- **全面历史**：短期（1-3个月）到长期（12个月）模式

### **📈 滚动统计特征（24个特征）**
- **窗口大小**：3、6、12个月滚动期间
- **统计测量**：均值、标准差、最小值、最大值、中位数、四分位数（Q25、Q75）
- **高级指标**：变异系数（CV）用于波动性评估
- **趋势稳定性**：趋势一致性的滚动统计

### **⚡ 动量和趋势特征（16个特征）**
- **同比分析**：上升/下降/稳定趋势分类
- **多时间框架趋势**：3个月、6个月趋势分析
- **加速度指标**：销售加速度、波动性测量
- **动量分类**：带持续时间跟踪的上升/下降/稳定动量
- **一致性测量**：趋势一致性和动量加速度

### **🏪 客户行为分析（124个特征）**

**店铺级分析（20个特征）：**
- **性能指标**：销售均值/标准差/最小值/最大值、金额统计
- **多样性测量**：品牌数量、产品数量、平台覆盖
- **质量指标**：一致性级别、规模分类
- **店铺类型**：旗舰店、官方、超市、专营、加盟分类

**品牌级分析（40个特征）：**
- **市场表现**：销售总额、市场份额（数量和金额）
- **分销指标**：店铺数量、平台覆盖、产品多样性
- **定价策略**：高端/预算/中档指标
- **性能层级**：低/中/高性能分类

**产品和平台分析（20个特征）：**
- **多样性指标**：产品数量和多样性级别
- **市场份额**：特定平台和跨平台市场定位
- **多平台策略**：平台独占性与全渠道存在

**品牌-平台交互（44个特征）：**
- **中国白酒品牌**：主要品牌的季节性模式（茅台、五粮液、西凤等）
- **平台特定表现**：京东特定品牌表现跟踪
- **跨平台分析**：抖音、京东、天猫平台的品牌表现

### **🏆 店铺分类特征（4个特征）**
- **竞争定位**：领导者、主要、次要、利基分类
- **市场主导地位**：竞争格局中的店铺位置
- **战略定位**：竞争优势评估

### **🔄 平台动态特征（19个特征）**
- **跨平台竞争**：多平台存在分析
- **性能比率**：特定平台性能比较
- **客户行为**：平台忠诚度与切换模式
- **经验级别**：新手、有经验、资深分类
- **季节性动态**：平台季节性性能指数
- **市场进入策略**：早期进入者、后期进入者、中期进入者分析

### **🚨 峰值检测特征（5个特征）**
- **异常检测**：销售z分数计算
- **峰值分类**：主要与中等峰值检测
- **偏差分析**：与移动平均的偏差
- **倾向性评分**：峰值倾向性风险评估

### **📋 特征工程总结**
- **总特征数**：316个工程化特征
- **特征类别**：9个主要分析类别
- **中国市场聚焦**：专为中国电商环境设计的特征
- **多时间框架分析**：短期（天）到长期（年）模式
- **商业智能**：全面的店铺、品牌和平台分析

## 🤖 模型架构

### **原版嵌入模型（基线）**
- **目的**：稳定的比较基线
- **架构**：标准嵌入+注意力机制
- **特征**：原始特征处理管道
- **用例**：基准测试、备用选项

### **增强嵌入模型（高级）**
- **目的**：生产就绪的增强性能
- **架构**：高级嵌入+多头注意力+残差连接
- **特征**：增强特征处理+正则化
- **改进**：
  - 更好的数值稳定性
  - 高级优化器（AdamW）
  - 增强回调
  - 改进的模型保存（Keras 3兼容）

### **关键技术特征**
- **多输入架构**：处理类别+连续特征
- **嵌入层**：高效的类别特征处理
- **注意力机制**：聚焦重要特征
- **正则化**：Dropout、批归一化、早停
- **自定义指标**：原始规模的MAPE和RMSE

## 📊 模型性能分析

### **预期性能基准**

| 指标 | 原版模型 | 增强模型 | 目标 |
|--------|---------------|----------------|---------|
| 验证MAPE | ~10-22% | **13.75% ± 6.94%** | <20% |
| 2023测试MAPE | ~30-45% | **30.35% ± 19.5%** | <20% |
| 训练时间 | ~70分钟 | 在Mac上~24小时 | - |

### **🔍 原版模型在2023年未见测试数据上的性能**

原版嵌入模型在2023年数据上进行评估，以评估其在完全未见数据上的泛化能力。以下是全面的性能分析：

![原版模型2023年评估](outputs/vanilla-model/reports/vanilla_model_2023_evaluation_plots_20250613_172409.png)

#### **📈 性能总结**
- **✅ 评估模型数**：5个交叉验证折叠
- **📊 最佳MAPE**：32.73%（折叠5）
- **📊 最差MAPE**：43.35%（折叠1）
- **📊 平均MAPE**：39.95%

### **🔍 增强模型在2023年未见测试数据上的性能**

增强嵌入模型在2023年数据上进行评估，以评估超越COVID时代训练期的真实世界性能。以下是综合分析：

#### **📈 性能摘要**
- **✅ 评估模型**：5个交叉验证折叠
- **📊 最佳MAPE**：19.00%（折叠1）- **达到业务就绪性能！**
- **📊 最差MAPE**：64.85%（折叠5）
- **📊 平均MAPE**：30.35%
- **🏆 总体评级**：中等到良好
- **💡 评估**：强劲表现，具有域适应机会
- **🏆 总体等级**：差
- **💡 评估**：❌ 性能差 - 需要显著改进

#### **🔬 详细分析**

**1. 按折叠的MAPE性能：**
- **折叠1**：43.4% - 最高误差，表明对训练期间的潜在过拟合
- **折叠2**：42.8% - 跨验证折叠的持续高误差
- **折叠3**：38.3% - 最佳性能折叠，显示一些泛化能力
- **折叠4**：42.6% - 类似于折叠1-2，表明系统性问题
- **折叠5**：32.7% - **最佳性能**，表明在最佳条件下的模型潜力

**2. RMSE一致性：**
- 所有折叠显示相似的RMSE值（~4500），表明一致的误差幅度
- 统一的RMSE表明模型在各折叠中保持预测规模一致性

**3. R²分数分析：**
- **关键问题**：所有R²分数都是负数（-0.001到-0.0025）
- **解释**：模型表现比简单预测均值更差
- **根本原因**：表明基本的模型架构或特征工程问题

**4. 实际vs预测散点图（最佳模型-折叠5）：**
- **严重低估**：模型持续预测比实际销售低得多的值
- **有限范围**：预测聚集在0-2000范围内，而实际销售达到15000+
- **差相关性**：散点图显示实际值与预测值之间没有清晰的线性关系

#### **🚨 识别的关键问题**

1. **规模不匹配**：模型无法捕获销售值的完整范围
2. **特征不足**：当前特征可能无法捕获基本的销售驱动因素
3. **架构限制**：原版嵌入方法对复杂模式不足
4. **时间泛化**：2023年的差性能表明对2021-2022年模式的过拟合

#### **💡 改进建议**

1. **增强模型架构**：
   - 实施多头注意力机制
   - 添加残差连接以改善梯度流
   - 用更深的网络增加模型容量

2. **特征工程增强**：
   - 添加更复杂的时间特征
   - 包含外部经济指标
   - 实施高级滞后和滚动窗口特征

3. **训练策略改进**：
   - 实施更稳健的交叉验证
   - 添加正则化技术
   - 使用高级优化器（AdamW、RMSprop）

4. **数据质量评估**：
   - 调查训练和测试期间的数据分布变化
   - 分析2023年数据中的异常值和异常
   - 考虑领域适应技术

这种分析清楚地证明了为什么开发**增强嵌入模型** - 解决这些基本限制并实现生产就绪的性能。

## 🔧 配置选项

### **模型选择**
```bash
--model-type vanilla    # 仅训练基线模型
--model-type enhanced   # 仅训练增强模型（默认）
--model-type both       # 训练两个模型进行比较
```

### **管道控制**
```bash
--run-phase3                    # 包含2023年评估
--skip-feature-engineering      # 使用现有工程化数据集
--engineered-dataset path.pkl   # 指定现有数据集
```

### **训练参数**
```bash
--epochs 150              # 训练轮数（默认：100）
--batch-size 256          # 批量大小（默认：512）
--random-seed 42          # 可重现性种子
--experiment-name "prod"  # 自定义实验名称
```

## 📈 输出结构

运行完整管道后，您将得到：

```
📁 outputs/
└── 📁 {实验名称}_YYYYMMDD_HHMMSS/
    ├── 📁 vanilla_models/              # 原版模型文件（.keras）
    ├── 📁 enhanced_models/             # 增强模型文件（.keras）
    ├── 📁 predictions/                 # CSV预测文件
    ├── 📁 reports/                     # 性能分析
    │   ├── 📄 training_summary.txt     # 训练结果
    │   ├── 📄 model_comparison.json    # 模型比较指标
    │   └── 📄 experiment_metadata.json # 实验配置
    └── 📁 2023_evaluation/             # 阶段3结果
        ├── 📄 evaluation_results.json  # 2023年测试性能
        ├── 📄 performance_plots.png    # 可视化
        └── 📄 business_recommendations.txt # 可操作见解
```

## 💡 使用提示

### **数据准备**
- 将Excel文件（2021.xlsx、2022.xlsx、2023.xlsx）放在`data/raw/`中
- 确保数据包含：店铺、品牌、产品、平台、销售、金额、价格列
- 检查中文字符编码（建议UTF-8）

### **性能优化**
- 增强模型在GPU上训练更快
- 使用`--batch-size 256`以获得更好的内存效率
- 设置`--random-seed`以确保可重现性

### **故障排除**
- 检查`logs/`目录中的详细错误信息
- 确保所有依赖项都已安装：`pip install -r requirements.txt`
- 验证数据格式与预期架构匹配

## 📞 支持

如有问题或需要帮助，请：
1. 查看详细的[使用指南](docs/USAGE_GUIDE.zh-CN.md)
2. 检查GitHub问题以获得常见解决方案
3. 联系开发团队寻求技术支持

---

**📝 注意**：此项目专为中国电商销售预测优化，具有特定的市场特征和平台集成。 